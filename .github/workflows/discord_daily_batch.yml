name: WOS Daily (Discord • Free OCR)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 8 * * *"   # 08:00 UTC daily

permissions:
  contents: read

concurrency:
  group: wos-daily
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    env:
      REDEEM_PACING_SECONDS: "1.8"   # tune to 2.0–2.5 if you still see 429s
      DEBUG: "1"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: System deps for OCR
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr libtesseract-dev

      - name: Install Python deps (Requests + Playwright + OCR stack)
        run: |
          python -m pip install --upgrade pip
          pip install requests playwright pillow pytesseract easyocr \
            torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
          python -m playwright install --with-deps chromium

      - name: Run daily job (free OCR)
        env:
          DISCORD_BOT_TOKEN:           ${{ secrets.DISCORD_BOT_TOKEN }}
          DISCORD_CODES_CHANNEL_ID:    ${{ secrets.DISCORD_CODES_CHANNEL_ID }}
          DISCORD_IDS_CHANNEL_ID:      ${{ secrets.DISCORD_IDS_CHANNEL_ID }}
          DISCORD_STATE_CHANNEL_ID:    ${{ secrets.DISCORD_STATE_CHANNEL_ID }}
          WOS_SECRET:                  ${{ secrets.WOS_SECRET }}
        run: |
          python scripts/daily_discord_batch_solver_free.py
